<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rotas - GPX Metropolitana</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtcJGpx2wp5SrfElJq7YIZvIflw=" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #111827;
      --bg-secondary: #1F2937;
      --bg-tertiary: #374151;
      --text-primary: #F9FAFB;
      --text-secondary: #9CA3AF;
      --accent-primary: #3B82F6;
      --accent-primary-hover: #2563EB;
      --accent-secondary: #4B5563;
      --accent-secondary-hover: #6B7280;
      --border-color: #4B5563;
      --shadow-color: rgba(0, 0, 0, 0.5);
      --radius-sm: 0.375rem; /* 6px */
      --radius-md: 0.5rem;   /* 8px */
      --radius-lg: 0.75rem;  /* 12px */
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      color-scheme: dark;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 1rem;
    }

    .app-container {
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      box-shadow: 0 4px 12px var(--shadow-color);
      max-width: 800px;
      width: 100%;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      border: 1px solid var(--border-color);
    }

    header {
      padding: 1.5rem;
      text-align: center;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border-bottom: 1px solid var(--border-color);
    }

    header h1 {
      margin-top: 0.5rem;
      font-size: 2rem;
    }

    .logo-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.75rem;
    }

    .logo {
      font-size: 2.5rem;
    }

    main {
      padding: 1.5rem;
      flex-grow: 1;
    }

    .search-section {
      margin-bottom: 1.5rem;
    }

    .search-container {
      display: flex;
      gap: 0.625rem;
      position: relative;
    }

    .search-container input {
      flex: 1;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border-color);
      background-color: var(--bg-primary);
      color: var(--text-primary);
      border-radius: var(--radius-md);
      font-size: 1rem;
      transition: border-color 0.3s;
    }

    .search-container input:focus {
      outline: none;
      border-color: var(--accent-primary);
    }

    .search-container button {
      padding: 0.75rem 1.25rem;
      border: none;
      background-color: var(--accent-primary);
      color: var(--text-primary);
      border-radius: var(--radius-md);
      font-size: 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: background-color 0.3s;
    }

    .search-container button:hover {
      background-color: var(--accent-primary-hover);
    }

    .search-container button svg {
      fill: var(--text-primary);
    }

    .loading-section {
      display: none;
      justify-content: center;
      align-items: center;
      gap: 0.625rem;
      padding: 1.25rem;
      color: var(--accent-primary);
    }

    .spinner {
      width: 1.5rem;
      height: 1.5rem;
      border: 4px solid var(--accent-primary);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .results-section h2 {
      margin-bottom: 1rem;
      font-size: 1.5rem;
      color: var(--text-primary);
    }

    .results-container {
      display: grid;
      gap: 1rem;
    }

    .route-card {
      background: var(--bg-tertiary);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-color);
      padding: 1.25rem;
      box-shadow: 0 2px 4px var(--shadow-color);
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.4s ease-out, transform 0.4s ease-out;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .route-card.slide-up {
      opacity: 1;
      transform: translateY(0);
      animation: slideUp 0.5s ease-out forwards;
    }

    .route-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
    }

    .route-info {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .route-number-container {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .route-number {
      background: var(--accent-primary);
      color: var(--text-primary);
      padding: 0.375rem 0.75rem;
      border-radius: var(--radius-sm);
      font-weight: bold;
      font-size: 1.2rem;
    }

    .route-name {
      font-size: 1.1rem;
      font-weight: 700;
    }
    
    .route-full-name {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .route-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.625rem;
    }

    .btn {
      padding: 0.625rem 1rem;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 4px var(--shadow-color);
    }

    .btn-primary {
      background-color: var(--accent-primary);
      color: var(--text-primary);
    }

    .btn-primary:hover {
      background-color: var(--accent-primary-hover);
    }

    .btn-secondary {
      background-color: var(--accent-secondary);
      color: var(--text-primary);
    }

    .btn-secondary:hover {
      background-color: var(--accent-secondary-hover);
    }

    .empty-results {
      text-align: center;
      padding: 1.25rem;
      color: var(--text-secondary);
      font-style: italic;
      opacity: 0;
      transition: opacity 0.5s ease-in;
    }

    .empty-results.fade-in {
      opacity: 1;
    }

    footer {
      text-align: center;
      padding: 1.25rem;
      border-top: 1px solid var(--border-color);
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .map-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease-out;
    }

    .map-modal.active {
      display: flex;
      opacity: 1;
    }

    .map-container {
      width: 90%;
      height: 90%;
      position: relative;
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: 0 8px 16px var(--shadow-color);
      border: 1px solid var(--border-color);
    }

    #map {
      width: 100%;
      height: 100%;
      z-index: 1;
    }

    .mini-map-container {
      width: 100%;
      height: 200px;
      border-radius: var(--radius-md);
      overflow: hidden;
      margin-top: 0.625rem;
      border: 1px solid var(--border-color);
    }
    
    .mini-map {
      width: 100%;
      height: 100%;
    }

    .map-controls {
      position: absolute;
      bottom: 20px;
      left:1rem;
      z-index: 1001;
    }

    .btn-close {
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      
      border: 1px solid var(--border-color);
      padding: 0.5rem 1rem;
      border-radius: var(--radius-md);
      cursor: pointer;
      
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1rem;
      transition: background-color 0.2s, color 0.2s;
    }

    .btn-close:hover {
      background-color: var(--accent-primary);
      color: var(--text-primary);
      
    }
    
    .leaflet-container {
      background-color: #333 !important;
      border-radius: var(--radius-md);
    }
    .leaflet-tile-pane {
      filter: brightness(0.8) contrast(1.1);
    }
    .leaflet-control-layers-toggle {
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="white"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>');
    }
    .leaflet-control-layers {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
    }
    .leaflet-control-zoom-in, .leaflet-control-zoom-out {
      background-color: var(--bg-secondary) !important;
      color: var(--text-primary) !important;
      border-color: var(--border-color) !important;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes fadeOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(10px); }
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-fade-in {
      animation: fadeIn 0.3s ease-out forwards;
    }
    
    .animate-fade-out {
      animation: fadeOut 0.3s ease-in forwards;
    }
    
    .animate-slide-up {
      opacity: 0;
      animation: slideUp 0.5s ease-out forwards;
    }

    /* Media Queries for Responsiveness */
    @media (max-width: 768px) {
      .app-container {
        max-width: 100%;
      }

      .search-container {
        flex-direction: column;
      }

      .search-container button {
        justify-content: center;
      }

      .results-container {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <header style="text-align: center; color: var(--accent-primary);">
      <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M8 6v6"></path>
        <path d="M16 6v6"></path>
        <path d="M2 12h19.6"></path>
        <path d="M18 18h3s.5-1.7.8-2.8c.1-.4.2-.8.2-1.2 0-.4-.1-.8-.2-1.2l-1.4-5C20.1 6.8 19.1 6 18 6H4a2 2 0 0 0-2 2v10h3"></path>
        <circle cx="7" cy="18" r="2"></circle>
        <path d="M9 18h5"></path>
        <circle cx="16" cy="18" r="2"></circle>
      </svg>
      <h1 style="font-size: 2.5rem; font-weight: 700; color: var(--text-primary); margin-top: 0.5rem;">GPX Route Viewer</h1>
      <p style="font-size: 1rem; color: var(--text-secondary);">Visualize e baixe rotas da Carris Metropolitana</p>
    </header>

    <main>
      <section class="search-section">
        <div class="search-container">
          <input type="text" id="routeNumber" placeholder="Digite o número da rota" aria-label="Número da rota">
          <button id="searchButton" onclick="searchRoutes()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M18.031 16.617l4.283 4.282-1.415 1.415-4.282-4.283A8.96 8.96 0 0 1 11 20c-4.968 0-9-4.032-9-9s4.032-9 9-9 9 4.032 9 9a8.96 8.96 0 0 1-1.969 5.617zm-2.006-.742A6.977 6.977 0 0 0 18 11c0-3.868-3.133-7-7-7-3.868 0-7 3.132-7 7 0 3.867 3.132 7 7 7a6.977 6.977 0 0 0 4.875-1.975l.15-.15z" fill="currentColor"/></svg>
            <span>Pesquisar</span>
          </button>
        </div>
      </section>

      <section class="loading-section" id="loading">
        <div class="loading-container">
          <div class="spinner"></div>
          <p>Carregando rotas...</p>
        </div>
      </section>

      <!-- The missing section with id="results" was added here -->
      <section class="results-section" id="results">
        <div class="animate-fade-in" style="text-align: center; padding: 2rem; background-color: var(--bg-secondary); border-radius: var(--radius-lg); color: var(--text-secondary);">
          <p>Bem-vindo! Insira o número de uma rota para começar.</p>
        </div>
      </section>
      
    </main>

    <footer style="text-align: center; font-size: 0.8rem; color: var(--text-secondary); padding: 1rem 0px; border-top: 1px solid var(--border-color); margin-top: 2rem;">
      <p>© 2025 - Ferramenta criada para a comunidade. | joao.sousa.martins@icloud.com</p>
    </footer>
  </div>

  <div id="mapModal" class="map-modal">
    <div class="map-container">
      <div id="map"></div>
      <div class="map-controls">
        <button id="closeMap" class="btn-close">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 10.586l4.95-4.95 1.414 1.414-4.95 4.95 4.95 4.95-1.414 1.414-4.95-4.95-4.95 4.95-1.414-1.414 4.95-4.95-4.95-4.95L7.05 5.636z" fill="currentColor"/></svg>
          <span>Fechar</span>
        </button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-polylinedecorator/dist/leaflet.polylineDecorator.js"></script>
  <script>
    /**
     * Main application script
     */
    
    // API Service for Carris Metropolitana
    const API_BASE_URL = 'https://api.carrismetropolitana.pt/v1';

    async function fetchAllRoutes() {
      try {
        const response = await fetch(`${API_BASE_URL}/routes`);
        if (!response.ok) throw new Error('Failed to fetch routes');
        return await response.json();
      } catch (error) {
        console.error('Error fetching routes:', error);
        throw error;
      }
    }

    async function fetchRouteDetails(routeId) {
      try {
        const response = await fetch(`${API_BASE_URL}/routes/${routeId}`);
        if (!response.ok) throw new Error(`Failed to fetch details for route ${routeId}`);
        return await response.json();
      } catch (error) {
        console.error(`Error fetching route details for ${routeId}:`, error);
        throw error;
      }
    }

    async function fetchPattern(patternId) {
      try {
        const response = await fetch(`${API_BASE_URL}/patterns/${patternId}`);
        if (!response.ok) throw new Error(`Failed to fetch pattern ${patternId}`);
        return await response.json();
      } catch (error) {
        console.error(`Error fetching pattern ${patternId}:`, error);
        throw error;
      }
    }

    async function fetchShapeData(shapeId) {
      try {
        const response = await fetch(`${API_BASE_URL}/shapes/${shapeId}`);
        if (!response.ok) throw new Error(`Failed to fetch shape ${shapeId}`);
        return await response.json();
      } catch (error) {
        console.error(`Error fetching shape ${shapeId}:`, error);
        throw error;
      }
    }

    function filterRoutesByNumber(routes, routeNumber) {
      return routes.filter(route => route.short_name === routeNumber);
    }

    function generateGpxContent(route, pattern, shapeData) {
      if (!shapeData.geojson?.geometry?.coordinates) {
        throw new Error('Shape data does not contain valid coordinates');
      }
      const routeName = `${route.short_name} - ${pattern.headsign}`;
      const gpxHeader = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="Carris Metropolitana" xmlns="http://www.topografix.com/GPX/1/1">
  <metadata>
    <name>${routeName}</name>
    <time>${new Date().toISOString()}</time>
  </metadata>
  <trk>
    <name>${routeName}</name>
    <trkseg>`;
      const gpxPoints = shapeData.geojson.geometry.coordinates
        .map(([lon, lat]) => `      <trkpt lat="${lat}" lon="${lon}"></trkpt>`)
        .join("\n");
      const gpxFooter = `
    </trkseg>
  </trk>
</gpx>`;
      return gpxHeader + gpxPoints + gpxFooter;
    }

    function downloadGpxFile(content, filename) {
      const blob = new Blob([content.trim()], { type: "application/gpx+xml" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Map utilities for main map modal
    let routeMap = null;
    let mapLayers = {
      route: null,
      markers: []
    };

    function initializeMainMap(startCoords) {
      if (routeMap) {
        routeMap.remove();
        mapLayers.route = null;
        mapLayers.markers = [];
      }
      routeMap = L.map('map').setView(startCoords, 13);
      const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap Contributors',
        maxZoom: 19
      });
      const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles © Esri',
        maxZoom: 19
      });
      osmLayer.addTo(routeMap);
      const baseMaps = {
        "Mapa Padrão": osmLayer,
        "Satélite": satelliteLayer
      };
      L.control.layers(baseMaps).addTo(routeMap);
      return routeMap;
    }

    function displayRouteOnMainMap(coordinates, routeName) {
      if (!coordinates || coordinates.length === 0) {
        showMessage('Nenhuma coordenada encontrada para esta rota.');
        return;
      }
      const latlngs = coordinates.map(([lon, lat]) => [lat, lon]);
      const startPoint = latlngs[0];
      const endPoint = latlngs[latlngs.length - 1];
      const map = initializeMainMap(startPoint);
      mapLayers.route = L.polyline(latlngs, {
        color: '#0066cc',
        weight: 8,
        opacity: 0.8,
        lineCap: 'round',
        lineJoin: 'round'
      }).addTo(map);
      const decorator = L.polylineDecorator(mapLayers.route, {
        patterns: [
          {
            offset: 25,
            repeat: 100,
            symbol: L.Symbol.arrowHead({
              pixelSize: 12,
              polygon: false,
              pathOptions: {
                stroke: true,
                color: '#ffcc00',
                weight: 3
              }
            })
          }
        ]
      }).addTo(map);
      const startMarker = L.marker(startPoint, {
        title: 'Início da rota',
        alt: 'Início'
      }).addTo(map);
      startMarker.bindPopup(`<strong>Início:</strong> ${routeName}`);
      mapLayers.markers.push(startMarker);
      const endMarker = L.marker(endPoint, {
        title: 'Fim da rota',
        alt: 'Fim'
      }).addTo(map);
      endMarker.bindPopup(`<strong>Fim:</strong> ${routeName}`);
      mapLayers.markers.push(endMarker);
      map.fitBounds(mapLayers.route.getBounds(), {
        padding: [50, 50]
      });
      showMapModal();
    }

    function showMapModal() {
      const mapModal = document.getElementById('mapModal');
      mapModal.style.display = 'flex';
      void mapModal.offsetWidth;
      mapModal.classList.add('active');
      if (routeMap) {
        setTimeout(() => {
          routeMap.invalidateSize();
        }, 300);
      }
    }

    function hideMapModal() {
      const mapModal = document.getElementById('mapModal');
      mapModal.classList.remove('active');
      setTimeout(() => {
        mapModal.style.display = 'none';
      }, 300);
    }
    
    // Map utilities for mini-map previews
    const miniMaps = new Map();

    function initializeMiniMap(mapId, coordinates, retries = 0) {
      const mapElement = document.getElementById(mapId);
      
      if (!mapElement || mapElement.clientHeight === 0 || mapElement.clientWidth === 0) {
        if (retries < 20) {
          setTimeout(() => initializeMiniMap(mapId, coordinates, retries + 1), 50);
        } else {
          console.error(`Failed to initialize mini-map ${mapId} after multiple attempts.`);
        }
        return null;
      }
      
      if (miniMaps.has(mapId)) {
        miniMaps.get(mapId).remove();
        miniMaps.delete(mapId);
      }
      
      const map = L.map(mapId, {
        zoomControl: false,
        attributionControl: false,
        dragging: false,
        touchZoom: false,
        scrollWheelZoom: false,
        doubleClickZoom: false,
        boxZoom: false,
        tap: false
      });
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
      
      if (coordinates && coordinates.length > 0) {
        const latlngs = coordinates.map(([lon, lat]) => [lat, lon]);
        const polyline = L.polyline(latlngs, {
          color: '#0066cc',
          weight: 3,
          opacity: 0.8
        }).addTo(map);
        map.fitBounds(polyline.getBounds(), { padding: [10, 10] });
      }

      map.invalidateSize(); 

      miniMaps.set(mapId, map);
      return map;
    }

    // Main App Logic
    document.addEventListener('DOMContentLoaded', () => {
      const routeInput = document.getElementById('routeNumber');
      routeInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          searchRoutes();
        }
      });
      routeInput.focus();
      document.getElementById('closeMap').addEventListener('click', hideMapModal);
      const mapModal = document.getElementById('mapModal');
      mapModal.addEventListener('click', (event) => {
        if (event.target === mapModal) {
          hideMapModal();
        }
      });
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && mapModal.classList.contains('active')) {
          hideMapModal();
        }
      });
    });

    /**
     * Search for routes by route number.
     * This function fetches all routes, filters by the user's input,
     * and then iterates through each route's patterns to display all
     * variations (headsigns) in the results.
     */
    async function searchRoutes() {
      const routeNumber = document.getElementById('routeNumber').value.trim();
      const resultsContainer = document.getElementById('results');
      const loadingElement = document.getElementById('loading');
      resultsContainer.innerHTML = ''; // Clear previous results
      if (!routeNumber) {
        showEmptyResults('Por favor, insira um número de rota.');
        return;
      }
      loadingElement.style.display = 'flex'; // Use flex for loading state

      try {
        const allRoutes = await fetchAllRoutes();
        const filteredRoutes = filterRoutesByNumber(allRoutes, routeNumber);

        if (filteredRoutes.length === 0) {
          showEmptyResults(`Nenhuma rota encontrada com o número ${routeNumber}.`);
          return;
        }

        const allRoutesData = [];

        for (const route of filteredRoutes) {
          try {
            const routeDetails = await fetchRouteDetails(route.id);
            if (!routeDetails.patterns || routeDetails.patterns.length === 0) {
              continue;
            }
            for (const patternId of routeDetails.patterns) {
              try {
                const pattern = await fetchPattern(patternId);
                if (!pattern.shape_id) {
                  continue;
                }
                const shapeData = await fetchShapeData(pattern.shape_id);
                
                allRoutesData.push({ route, pattern, shapeData });
              } catch (error) {
                console.error(`Error processing pattern ${patternId} for route ${route.id}:`, error);
              }
            }
          } catch (error) {
            console.error(`Error processing route ${route.id}:`, error);
          }
        }
        
        if (allRoutesData.length > 0) {
          let routeItemsHTML = '';
          allRoutesData.forEach((data, index) => {
            routeItemsHTML += createRouteCard(data.route, data.pattern, index);
          });
          resultsContainer.innerHTML = routeItemsHTML;

          allRoutesData.forEach((data, index) => {
            const mapId = `mini-map-${index}`;
            const coordinates = data.shapeData.geojson?.geometry?.coordinates;
            initializeMiniMap(mapId, coordinates);

            const card = document.getElementById(`card-${index}`);
            if (card) {
              setTimeout(() => {
                card.classList.add('slide-up');
              }, index * 100);
            }
          });
        } else {
          showEmptyResults(`Nenhuma rota encontrada com padrões para o número ${routeNumber}.`);
        }
      } catch (error) {
        console.error('Error in search process:', error);
        showEmptyResults('Ocorreu um erro ao buscar as rotas. Por favor, tente novamente.');
      } finally {
        loadingElement.style.display = 'none';
      }
    }

    function createRouteCard(route, pattern, index) {
      return `
        <div class="route-card" id="card-${index}">
          <div class="route-header">
            <div class="route-info">
              <div class="route-number-container">
                <div class="route-number">${route.short_name}</div>
                <div class="route-name">Destino: ${pattern.headsign}</div>
              </div>
              <div class="route-full-name">${route.long_name}</div>
            </div>
            <div class="route-actions">
              <button class="btn btn-primary" onclick="previewRoute('${pattern.shape_id}', '${route.short_name} - ${pattern.headsign}')">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18"><path fill="none" d="M0 0h24v24H0z"/><path d="M18.364 17.364L12 23.728l-6.364-6.364a9 9 0 1 1 12.728 0zM12 15a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" fill="currentColor"/></svg>
                <span>Visualizar no Mapa</span>
              </button>
              <button class="btn btn-secondary" onclick="downloadRoute('${route.id}', '${pattern.id}')">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18"><path fill="none" d="M0 0h24v24H0z"/><path d="M3 19h18v2H3v-2zm10-5.828L19.071 7.1l1.414 1.414L12 17 3.515 8.515 4.929 7.1 11 13.17V2h2v11.172z" fill="currentColor"/></svg>
                <span>Baixar GPX</span>
              </button>
            </div>
          </div>
          <div class="mini-map-container">
            <div id="mini-map-${index}" class="mini-map"></div>
          </div>
        </div>
      `;
    }

    function showEmptyResults(message) {
      const resultsContainer = document.getElementById('results');
      resultsContainer.innerHTML = `
        <div class="empty-results fade-in">
          <p>${message}</p>
        </div>
      `;
    }

    function showMessage(message) {
      const outputDiv = document.getElementById('output');
      if (outputDiv) {
        outputDiv.textContent = message;
      }
      console.log(message);
    }
    
    async function previewRoute(shapeId, routeName) {
      const loadingElement = document.getElementById('loading');
      loadingElement.style.display = 'flex';
      try {
        const shapeData = await fetchShapeData(shapeId);
        const coordinates = shapeData.geojson?.geometry?.coordinates;
        if (!coordinates || coordinates.length === 0) {
          showMessage('Coordenadas não encontradas para esta rota.');
          return;
        }
        displayRouteOnMainMap(coordinates, routeName);
      } catch (error) {
        console.error('Error previewing route:', error);
        showMessage('Ocorreu um erro ao carregar os dados da rota para visualização.');
      } finally {
        loadingElement.style.display = 'none';
      }
    }

    async function downloadRoute(routeId, patternId) {
      const loadingElement = document.getElementById('loading');
      loadingElement.style.display = 'flex';
      try {
        const routeDetails = await fetchRouteDetails(routeId);
        const pattern = await fetchPattern(patternId);
        if (!pattern.shape_id) {
          showMessage('Dados indisponíveis para esta rota.');
          return;
        }
        const shapeData = await fetchShapeData(pattern.shape_id);
        const gpxContent = generateGpxContent(routeDetails, pattern, shapeData);
        const sanitizedHeadsign = pattern.headsign.replace(/[/\\?%*:|"<>]/g, '-');
        const filename = `${routeDetails.short_name}-${sanitizedHeadsign}.gpx`;
        downloadGpxFile(gpxContent, filename);
      } catch (error) {
        console.error('Error downloading route:', error);
        showMessage('Ocorreu um erro ao gerar o arquivo GPX.');
      } finally {
        loadingElement.style.display = 'none';
      }
    }
  </script>
</body>
</html>

<script type="importmap">
{
  "imports": {
    "react/": "https://aistudiocdn.com/react@^19.1.1/",
    "react": "https://aistudiocdn.com/react@^19.1.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.1.1/"
  }
}
</script>
</head>
<body>
  <div id="root"></div>
</body>
</html>
